{"version":3,"file":"start.js","sourceRoot":"","sources":["../../src/start.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\nimport * as winston from 'winston'\nimport { App } from './app'\nimport Knex from 'knex'\nimport { Model } from 'objection'\nimport { AgreementBucket } from './services/agreementBucket'\nimport Redis from 'ioredis'\n\nconst PORT = Number(process.env.PORT) || 3002\nconst DATABASE_CONNECTION_STRING = process.env.DATABASE_CONNECTION_STRING || ':memory:'\nconst DATABASE_CLIENT = process.env.DATABASE_CLIENT || 'sqlite3'\n\nconst REDIS_URI = process.env.REDIS_URI\n\n// tslint:disable-next-line\nconst stringify = (value: any): string => typeof value === 'bigint' ? value.toString() : JSON.stringify(value)\nconst formatter = winston.format.printf(({ service, level, message, component, timestamp, ...metaData }) => {\n  return `${timestamp} [${service}${component ? '-' + component : ''}] ${level}: ${message}` + (metaData ? ' meta data: ' + stringify(metaData) : '')\n})\n\nwinston.configure({\n  level: process.env.LOG_LEVEL || 'info',\n  format: winston.format.combine(\n    winston.format.colorize(),\n    winston.format.timestamp(),\n    winston.format.align(),\n    formatter\n  ),\n  defaultMeta: { service: 'ishara' },\n  transports: [\n    new winston.transports.Console()\n  ]\n})\n\n// configure knex and bind to objection js\nconst knex = Knex({\n  client: DATABASE_CLIENT,\n  connection: DATABASE_CONNECTION_STRING\n})\nconsole.log('db conn string', DATABASE_CONNECTION_STRING)\nModel.knex(knex)\n\nconst redis = new Redis(REDIS_URI)\nconst agreementBucket = new AgreementBucket(redis)\n\nconst app = new App(agreementBucket)\n\nconst gracefulShutdown = async (): Promise<void> => {\n  app.shutdown()\n  // knex.destroy()\n}\n\nconst start = async (): Promise<void> => {\n  let shuttingDown = false\n  process.on('SIGINT', async () => {\n    try {\n      if (shuttingDown) {\n        winston.warn('received second SIGINT during graceful shutdown, exiting forcefully.')\n        process.exit(1)\n        return\n      }\n\n      shuttingDown = true\n\n      // Graceful shutdown\n      await gracefulShutdown()\n      process.exit(0)\n    } catch (err) {\n      const errInfo = (err && typeof err === 'object' && err.stack) ? err.stack : err\n      winston.error('error while shutting down. error=%s', errInfo)\n      process.exit(1)\n    }\n  })\n\n  if (knex.client.config.connection.filename === ':memory:') {\n    await knex.migrate.latest()\n  } else {\n    const status = await knex.migrate.status().catch(error => {\n      winston.error('Error getting migrations status.', { error })\n      winston.info('Please ensure your run the migrations before starting Ishara')\n      process.exit(1)\n    })\n    if (status !== 0) {\n      winston.error('You need to run the latest migrations before running Ishara')\n      process.exit(1)\n    }\n  }\n\n  app.listen(PORT)\n}\n\nstart().catch(e => {\n  const errInfo = (e && typeof e === 'object' && e.stack) ? e.stack : e\n  winston.error(errInfo)\n})\n"]}