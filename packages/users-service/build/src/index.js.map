{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import createLogger from 'pino'\nimport { App } from './app'\nimport { Model } from 'objection'\nimport { TokenService } from './services/token-service'\nimport Knex = require('knex')\nconst logger = createLogger()\nlogger.level = process.env.LOG_LEVEL || 'info'\n\nconst PORT = process.env.PORT || 3000\nconst KNEX_CLIENT = process.env.KNEX_CLIENT || 'sqlite3'\nconst knex = KNEX_CLIENT === 'mysql' ? Knex({\n  client: 'mysql',\n  connection: {\n    host: process.env.MYSQL_HOST,\n    user: process.env.MYSQL_USER,\n    password: process.env.MYSQL_PASSWORD,\n    database: process.env.MYSQL_DATABASE\n  }\n}) : Knex({\n  client: 'sqlite3',\n  connection: {\n    filename: ':memory:'\n  }\n})\n\nconst tokenService = new TokenService({\n  clientId: process.env.OAUTH_CLIENT_ID || 'wallet-users-service',\n  clientSecret: process.env.OAUTH_CLIENT_SECRET || '',\n  issuerUrl: process.env.OAUTH_ISSUER_URL || 'https://auth.rafiki.money',\n  tokenRefreshTime: 0\n})\n\nconst app = new App(logger, tokenService)\n\nexport const gracefulShutdown = async (): Promise<void> => {\n  logger.info('shutting down.')\n  app.shutdown()\n  await knex.destroy()\n}\n\nexport const start = async (): Promise<void> => {\n  let shuttingDown = false\n  process.on('SIGINT', async (): Promise<void> => {\n    try {\n      if (shuttingDown) {\n        logger.warn('received second SIGINT during graceful shutdown, exiting forcefully.')\n        process.exit(1)\n        return\n      }\n\n      shuttingDown = true\n\n      // Graceful shutdown\n      await gracefulShutdown()\n      logger.info('completed graceful shutdown.')\n    } catch (err) {\n      const errInfo = (err && typeof err === 'object' && err.stack) ? err.stack : err\n      logger.error('error while shutting down. error=%s', errInfo)\n      process.exit(1)\n    }\n  })\n\n  // Do migrations\n  await knex.migrate.latest()\n  Model.knex(knex)\n\n  app.listen(PORT)\n  logger.info(`Listening on ${PORT}`)\n}\n\n// If this script is run directly, start the server\nif (!module.parent) {\n  start().catch(e => {\n    const errInfo = (e && typeof e === 'object' && e.stack) ? e.stack : e\n    logger.error(errInfo)\n  })\n}\n"]}